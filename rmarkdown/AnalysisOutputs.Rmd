
---
title: "AnalysisOutputs"
output: html_document
params: 
  yamlfile: NA
  sampleid: NA
  three_nucleotide_periodicity_data_file: NA
  read_length_data_file: NA
  pos_sp_rpf_norm_reads_data_file: NA
  gene_read_frames_data_file: NA
  asite_disp_length_file: NA
---

NOTE: installed & added yaml, knitr & rmarkdown to the library() calls! Need to update documentation/installation etc too. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

suppressMessages(library(here))
#suppressMessages(library(magrittr))
suppressMessages(library(getopt))
suppressMessages(library(knitr)) 
suppressMessages(library(yaml))
suppressMessages(library(tidyverse))
```

```{r optional_params, echo=TRUE}

### handling optional outputs parameters: 

yaml <- read_yaml(params$yamlfile)

# show yaml params
print(str(yaml))

if (is.null(yaml$asite_disp_length_file)){
  asite_disp_length <- NA
} else {
  asite_disp_length <- "present"
}


```

## Sample Name: `r params$sampleid`

```{r printparams, echo=TRUE}
#print(params$yamlfile)

print(params$sampleid)
print(params$three_nucleotide_periodicity_data_file)

#print(params$asite_disp_length_file)
#print(params$gene_read_frames_data_file)
print(asite_disp_length)

```

```{r source_script, include=FALSE}

source(here::here("rscripts", "provenance.R"), local = knitr::knit_global())
source(here::here("rscripts", "read_count_functions.R"), local = knitr::knit_global())
source(here::here("rscripts", "stats_figs_block_functions.R"), local = knitr::knit_global())
# or sys.source("your-script.R", envir = knitr::knit_global())
```

### Provenance

```{r provenance, echo=FALSE, warning=FALSE}
# handle interactive vs standard running

if(is.na(getopt::get_Rscript_filename())){
  this_script <- "AnalysisOutputs.Rmd"
  path_to_this_script <- here::here("rmarkdown", this_script)
} else {
  this_script <- getopt::get_Rscript_filename()
  path_to_this_script <- this_script
}

# print provenance
print_provenance(path_to_this_script)
```

```{r message=FALSE, include=FALSE}

### Load Data: 

# three nucleotide periodicity
three_nucleotide_periodicity_data <- read_tsv(
  file = params$three_nucleotide_periodicity_data_file, 
  skip = 4, # this avoids the provenance info
  col_names = TRUE)

# read length
read_length_data <- read_tsv(
  file = params$read_length_data_file, 
  skip = 4, # this avoids the provenance info
  col_names = TRUE)

# position specific distribution of reads 
pos_sp_rpf_norm_reads_data <- read_tsv(
  file = params$pos_sp_rpf_norm_reads_data_file, 
  skip = 4, # this avoids the provenance info
  col_names = TRUE)

# read frame (conditional on --asite-disp-length-file)
if (!is.na(asite_disp_length)){
  gene_read_frames_data <- read_tsv(
    file = params$gene_read_frames_data_file, 
    skip = 4, # this avoids the provenance info
    col_names = TRUE)
}

```

#### Plotting three nucleotide periodicity. 

```{r plot_threenucleotideperiodicity, echo=FALSE}

# three nucleotide periodicity
PlotThreeNucleotidePeriodicity(three_nucleotide_periodicity_data)

```

#### Plotting read lengths.

```{r plot_readlength, echo=FALSE}

# read length
PlotReadLengths(read_length_data)

```

#### Plotting read lengths.

```{r plot_positionspecificdistribution, echo=FALSE}

# position specific distribution of reads
PlotPositionSpecificDistributionOfReads(pos_sp_rpf_norm_reads_data)

```

```{r proportionframe, echo=FALSE}

# plot read frame
if (!is.na(asite_disp_length)){
  
  # filter gene_read_frames_data to remove counts over the count_threshold
  gene_read_frame_data_filtered <- 
    FilterGeneReadFrames(gene_read_frames_data, yaml$count_threshold)
  
  # run PlotGeneReadFrames():
  PlotGeneReadFrames(gene_read_frame_data_filtered)
}
```
